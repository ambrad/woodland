// Derived from https://github.com/E3SM-Project/COMPOSE; see
//     https://github.com/E3SM-Project/COMPOSE/blob/main/LICENSE
// for details of the 3-clause BSD license.

#include <cstdio>
#include <cassert>

#include <initializer_list>

#include "woodland/acorn/compose_triquad.hpp"

namespace woodland {
namespace acorn {

/* For the TRISYM entries, see, e.g.,
     Dunavant, D.A. "High Degree Efficient Symmetrical Gaussian Quadrature Rules
     for the Triangle."  J. Numer. Meth. Eng., 21, pp 1129-1148.
   and
     Zhang, Linbo, Tao Cui, and Hui Liu. "A set of symmetric quadrature rules on
     triangles and tetrahedra." J. of Computational Mathematics (2009): 89-96.
   For the TRITAYLOR, see
     Day, David M. and Mark A. Taylor, "A new 11 point degree 6 cubature formula
     for the triangle", PAMM 7 (2007)
   and
     Taylor, Mark A., Beth A. Wingate, and Len P. Bos. "A cardinal function
     algorithm for computing multivariate quadrature points." SIAM Journal on
     Numerical Analysis 45.1 (2007): 193-205.
*/

#define SIQK_QUADRATURE_TRISYM_ORDER1_COORD     \
  {1.0/3.0, 1.0/3.0, 1.0/3.0}
#define SIQK_QUADRATURE_TRISYM_ORDER1_WEIGHT    \
  {1.0}

#define SIQK_QUADRATURE_TRISYM_ORDER2_COORD     \
  {2.0/3.0, 1.0/6.0, 1.0/6.0,                   \
   1.0/6.0, 2.0/3.0, 1.0/6.0,                   \
   1.0/6.0, 1.0/6.0, 2.0/3.0}
#define SIQK_QUADRATURE_TRISYM_ORDER2_WEIGHT    \
  {1.0/3.0, 1.0/3.0, 1.0/3.0}

#define SIQK_QUADRATURE_TRISYM_ORDER4_COORD                  \
  {0.108103018168070, 0.445948490915965, 0.445948490915965,  \
   0.445948490915965, 0.108103018168070, 0.445948490915965,  \
   0.445948490915965, 0.445948490915965, 0.108103018168070,  \
   0.816847572980458, 0.091576213509771, 0.091576213509771,  \
   0.091576213509771, 0.816847572980458, 0.091576213509771,  \
   0.091576213509771, 0.091576213509771, 0.816847572980458}
#define SIQK_QUADRATURE_TRISYM_ORDER4_WEIGHT                 \
  {0.223381589678011, 0.223381589678011, 0.223381589678011,  \
   0.109951743655322, 0.109951743655322, 0.109951743655322}

#define SIQK_QUADRATURE_TRITAY_ORDER6_COORD                             \
  {4.724686653264358e-02, 5.725498667747682e-02, 8.954981467898796e-01, \
   4.280913872509884e-02, 8.953626400245792e-01, 6.182822125032195e-02, \
   2.921805130458027e-01, 6.844757484565146e-01, 2.334373849768268e-02, \
   8.712234683377076e-01, 6.874625591502949e-02, 6.003027574726293e-02, \
   5.086198608278325e-02, 6.156762055758400e-01, 3.334618083413767e-01, \
   2.128646728100595e-01, 6.279461411977890e-01, 1.591891859921515e-01, \
   2.817957679526839e-01, 6.290913834186361e-02, 6.552950937054525e-01, \
   6.225041026512227e-01, 6.837821192050995e-02, 3.091176854282673e-01, \
   7.604403244598745e-02, 2.875294583743921e-01, 6.364265091796204e-01, \
   5.941924379444020e-01, 3.287835564131346e-01, 7.702400564246337e-02, \
   3.353648085404556e-01, 3.122904050136449e-01, 3.523447864458995e-01}

#define SIQK_QUADRATURE_TRITAY_ORDER6_WEIGHT                            \
  {3.806807185295551e-02, 3.837935530775279e-02, 4.620045674456197e-02, \
   5.346758944419899e-02, 8.375582696574595e-02, 1.016448330255167e-01, \
   1.018615244613670e-01, 1.114218316600018e-01, 1.120094502629461e-01, \
   1.247875714375583e-01, 1.884034888373949e-01}

#define SIQK_QUADRATURE_TRISYM_ORDER8_COORD                  \
  {0.333333333333333, 0.333333333333333, 0.333333333333333,  \
   0.081414823414554, 0.459292588292723, 0.459292588292723,  \
   0.459292588292723, 0.081414823414554, 0.459292588292723,  \
   0.459292588292723, 0.459292588292723, 0.081414823414554,  \
   0.658861384496480, 0.170569307751760, 0.170569307751760,  \
   0.170569307751760, 0.658861384496480, 0.170569307751760,  \
   0.170569307751760, 0.170569307751760, 0.658861384496480,  \
   0.898905543365938, 0.050547228317031, 0.050547228317031,  \
   0.050547228317031, 0.898905543365938, 0.050547228317031,  \
   0.050547228317031, 0.050547228317031, 0.898905543365938,  \
   0.008394777409958, 0.263112829634638, 0.728492392955404,  \
   0.008394777409958, 0.728492392955404, 0.263112829634638,  \
   0.263112829634638, 0.008394777409958, 0.728492392955404,  \
   0.263112829634638, 0.728492392955404, 0.008394777409958,  \
   0.728492392955404, 0.263112829634638, 0.008394777409958,  \
   0.728492392955404, 0.008394777409958, 0.263112829634638}
#define SIQK_QUADRATURE_TRISYM_ORDER8_WEIGHT                 \
  {0.144315607677787, 0.095091634267285, 0.095091634267285,  \
   0.095091634267285, 0.103217370534718, 0.103217370534718,  \
   0.103217370534718, 0.032458497623198, 0.032458497623198,  \
   0.032458497623198, 0.027230314174435, 0.027230314174435,  \
   0.027230314174435, 0.027230314174435, 0.027230314174435,  \
   0.027230314174435}

#define SIQK_QUADRATURE_TRITAY_ORDER12_COORD \
  {7.26510255160501828e-02, 9.27348974483949817e-01, 0.00000000000000000e+00, \
   2.11790731803609689e-02, 2.35517332495786824e-02, 9.55269193570060349e-01, \
   1.41841115784669236e-01, 5.40914911362088088e-17, 8.58158884215330708e-01, \
   1.15143666726236216e-02, 9.45475073220970907e-01, 4.30105601064054710e-02, \
   2.77555756156289135e-17, 1.54064601626856063e-01, 8.45935398373143910e-01, \
   3.72684680767588483e-01, -1.88694080537681499e-16, 6.27315319232411683e-01, \
   9.43134911146902510e-01, 2.71109713562557482e-02, 2.97541174968417414e-02, \
   8.44725347421859452e-01, 1.46044961672175677e-01, 9.22969090596487129e-03, \
   8.23277107647898521e-01, 2.11522233831219000e-02, 1.55570668968979586e-01, \
   6.21586880750877868e-01, 1.45665147883470222e-02, 3.63846604460775103e-01, \
   2.21919501597089841e-02, 7.88601719223131714e-01, 1.89206330617159302e-01, \
   2.27722111443204644e-01, 7.49189739790679599e-01, 2.30881487661157569e-02, \
   7.38137544226065284e-02, 7.18714961015890358e-02, 8.54314749475804436e-01, \
   6.43364629415364875e-01, 3.32129083947645065e-01, 2.45062866369900600e-02, \
   2.28091126376529507e-02, 3.61181591189672080e-01, 6.16009296172674969e-01, \
   6.63093778446759319e-01, 2.43458133948799671e-01, 9.34480876044410103e-02, \
   2.51456820638045198e-02, 5.81689214740147453e-01, 3.93165103196048027e-01, \
   4.29837040104380730e-01, 5.44446676271925334e-01, 2.57162836236939363e-02, \
   9.40413011410586863e-02, 8.26003314017559997e-01, 7.99553848413813162e-02, \
   7.94010795132135239e-01, 1.16386499067277244e-01, 8.96027058005875177e-02, \
   7.83496599417470019e-02, 2.03768481077729741e-01, 7.17881858980523258e-01, \
   2.25505520049374242e-01, 6.44132203822605637e-02, 7.10081259568365097e-01, \
   6.43800731623786371e-01, 9.54285858105846096e-02, 2.60770682565629019e-01, \
   5.43837635808460451e-01, 2.44982965093490213e-01, 2.11179399098049336e-01, \
   4.32112641877997194e-01, 7.05667243440369213e-02, 4.97320633777965815e-01, \
   2.55495747579340349e-01, 6.19381257362555782e-01, 1.25122995058103870e-01, \
   1.22162380966293838e-01, 6.27682615680314027e-01, 2.50155003353392136e-01, \
   4.47861373562203791e-01, 4.22605657433460014e-01, 1.29532969004336196e-01, \
   4.09354529674576528e-01, 2.10785259391403995e-01, 3.79860210934019449e-01, \
   1.24718320885524481e-01, 4.08963804491244809e-01, 4.66317874623230710e-01, \
   2.28197277938737758e-01, 2.13777432530059680e-01, 5.58025289531202562e-01, \
   2.88796329020881648e-01, 4.09786577770025306e-01, 3.01417093209092990e-01}

#define SIQK_QUADRATURE_TRITAY_ORDER12_WEIGHT                           \
  {4.888049814660050e-03, 6.675900027367356e-03, 6.845534654343699e-03, \
   7.119751436080721e-03, 7.714492373624846e-03, 9.654708742436301e-03, \
   1.050932673560249e-02, 1.068084365762828e-02, 1.848368581123072e-02, \
   1.854548042160657e-02, 2.062000411968213e-02, 2.168508541701153e-02, \
   2.249074619915818e-02, 2.490407320150775e-02, 2.509917342768508e-02, \
   2.794373431987983e-02, 2.814555860521331e-02, 2.816965445973000e-02, \
   3.052917241207244e-02, 3.057527760403899e-02, 3.957360579297199e-02, \
   4.128188739546268e-02, 4.593784216579169e-02, 4.749957532530720e-02, \
   4.814880503690738e-02, 5.096492487678762e-02, 5.335208304882109e-02, \
   5.414687261316752e-02, 5.943783395113540e-02, 5.998970732710617e-02, \
   6.316454642265663e-02, 7.522206260332436e-02}

#define SIQK_QUADRATURE_TRISYM_ORDER20_COORD \
  {0.3333333333333333148296162562473910, 0.3333333333333333148296162562473910, 0.3333333333333333148296162562473910, \
   0.2158743059329919777855621987328050, 0.2158743059329919777855621987328050, 0.5682513881340160999400268337922171, \
   0.2158743059329919777855621987328050, 0.5682513881340160999400268337922171, 0.2158743059329919777855621987328050, \
   0.5682513881340160999400268337922171, 0.2158743059329919777855621987328050, 0.2158743059329919777855621987328050, \
   0.0753767665297472716501303580116655, 0.0753767665297472716501303580116655, 0.8492464669405054289441636683477554, \
   0.0753767665297472716501303580116655, 0.8492464669405054289441636683477554, 0.0753767665297472716501303580116655, \
   0.8492464669405054289441636683477554, 0.0753767665297472716501303580116655, 0.0753767665297472716501303580116655, \
   0.0103008281372217926769030427180951, 0.0103008281372217926769030427180951, 0.9793983437255564528101103860535659, \
   0.0103008281372217926769030427180951, 0.9793983437255564528101103860535659, 0.0103008281372217926769030427180951, \
   0.9793983437255564528101103860535659, 0.0103008281372217926769030427180951, 0.0103008281372217926769030427180951, \
   0.4936022112987001886352800283930264, 0.4936022112987001886352800283930264, 0.0127955774025996227294399432139471, \
   0.4936022112987001886352800283930264, 0.0127955774025996227294399432139471, 0.4936022112987001886352800283930264, \
   0.0127955774025996227294399432139471, 0.4936022112987001886352800283930264, 0.4936022112987001886352800283930264, \
   0.4615509381069253236340443891094765, 0.4615509381069253236340443891094765, 0.0768981237861493527319112217810471, \
   0.4615509381069253236340443891094765, 0.0768981237861493527319112217810471, 0.4615509381069253236340443891094765, \
   0.0768981237861493527319112217810471, 0.4615509381069253236340443891094765, 0.4615509381069253236340443891094765, \
   0.3286214064242369836676971317501739, 0.4293405702582103744546770940360148, 0.2420380233175526418776257742138114, \
   0.3286214064242369836676971317501739, 0.2420380233175526418776257742138114, 0.4293405702582103744546770940360148, \
   0.4293405702582103744546770940360148, 0.3286214064242369836676971317501739, 0.2420380233175526418776257742138114, \
   0.4293405702582103744546770940360148, 0.2420380233175526418776257742138114, 0.3286214064242369836676971317501739, \
   0.2420380233175526418776257742138114, 0.3286214064242369836676971317501739, 0.4293405702582103744546770940360148, \
   0.2420380233175526418776257742138114, 0.4293405702582103744546770940360148, 0.3286214064242369836676971317501739, \
   0.2604803617865687481724989993381314, 0.1015775342809694392620656344661256, 0.6379421039324617570542841349379160, \
   0.2604803617865687481724989993381314, 0.6379421039324617570542841349379160, 0.1015775342809694392620656344661256, \
   0.1015775342809694392620656344661256, 0.2604803617865687481724989993381314, 0.6379421039324617570542841349379160, \
   0.1015775342809694392620656344661256, 0.6379421039324617570542841349379160, 0.2604803617865687481724989993381314, \
   0.6379421039324617570542841349379160, 0.2604803617865687481724989993381314, 0.1015775342809694392620656344661256, \
   0.6379421039324617570542841349379160, 0.1015775342809694392620656344661256, 0.2604803617865687481724989993381314, \
   0.1370742358464553112273875967730419, 0.7100659730011301684626801034028176, 0.1528597911524145480655079154530540, \
   0.1370742358464553112273875967730419, 0.1528597911524145480655079154530540, 0.7100659730011301684626801034028176, \
   0.7100659730011301684626801034028176, 0.1370742358464553112273875967730419, 0.1528597911524145480655079154530540, \
   0.7100659730011301684626801034028176, 0.1528597911524145480655079154530540, 0.1370742358464553112273875967730419, \
   0.1528597911524145480655079154530540, 0.1370742358464553112273875967730419, 0.7100659730011301684626801034028176, \
   0.1528597911524145480655079154530540, 0.7100659730011301684626801034028176, 0.1370742358464553112273875967730419, \
   0.1467269458722997854671632467216114, 0.4985454776784148389623396724346094, 0.3547275764492854310816483121016063, \
   0.1467269458722997854671632467216114, 0.3547275764492854310816483121016063, 0.4985454776784148389623396724346094, \
   0.4985454776784148389623396724346094, 0.1467269458722997854671632467216114, 0.3547275764492854310816483121016063, \
   0.4985454776784148389623396724346094, 0.3547275764492854310816483121016063, 0.1467269458722997854671632467216114, \
   0.3547275764492854310816483121016063, 0.1467269458722997854671632467216114, 0.4985454776784148389623396724346094, \
   0.3547275764492854310816483121016063, 0.4985454776784148389623396724346094, 0.1467269458722997854671632467216114, \
   0.0269989777425532900823057502748270, 0.0491867226725819992050325879517914, 0.9238142995848647176515555656806100, \
   0.0269989777425532900823057502748270, 0.9238142995848647176515555656806100, 0.0491867226725819992050325879517914, \
   0.0491867226725819992050325879517914, 0.0269989777425532900823057502748270, 0.9238142995848647176515555656806100, \
   0.0491867226725819992050325879517914, 0.9238142995848647176515555656806100, 0.0269989777425532900823057502748270, \
   0.9238142995848647176515555656806100, 0.0269989777425532900823057502748270, 0.0491867226725819992050325879517914, \
   0.9238142995848647176515555656806100, 0.0491867226725819992050325879517914, 0.0269989777425532900823057502748270, \
   0.0618717859336170294959345028473763, 0.7796601465405693653920593533257488, 0.1584680675258135496008549125690479, \
   0.0618717859336170294959345028473763, 0.1584680675258135496008549125690479, 0.7796601465405693653920593533257488, \
   0.7796601465405693653920593533257488, 0.0618717859336170294959345028473763, 0.1584680675258135496008549125690479, \
   0.7796601465405693653920593533257488, 0.1584680675258135496008549125690479, 0.0618717859336170294959345028473763, \
   0.1584680675258135496008549125690479, 0.0618717859336170294959345028473763, 0.7796601465405693653920593533257488, \
   0.1584680675258135496008549125690479, 0.7796601465405693653920593533257488, 0.0618717859336170294959345028473763, \
   0.0477243674276219970176171614184568, 0.3704915391495476328920233299868414, 0.5817840934228304394792985476669855, \
   0.0477243674276219970176171614184568, 0.5817840934228304394792985476669855, 0.3704915391495476328920233299868414, \
   0.3704915391495476328920233299868414, 0.0477243674276219970176171614184568, 0.5817840934228304394792985476669855, \
   0.3704915391495476328920233299868414, 0.5817840934228304394792985476669855, 0.0477243674276219970176171614184568, \
   0.5817840934228304394792985476669855, 0.0477243674276219970176171614184568, 0.3704915391495476328920233299868414, \
   0.5817840934228304394792985476669855, 0.3704915391495476328920233299868414, 0.0477243674276219970176171614184568, \
   0.1206005151863643737319975457467081, 0.8633469487547525966775197048264090, 0.0160525360588830157126949416124262, \
   0.1206005151863643737319975457467081, 0.0160525360588830157126949416124262, 0.8633469487547525966775197048264090, \
   0.8633469487547525966775197048264090, 0.1206005151863643737319975457467081, 0.0160525360588830157126949416124262, \
   0.8633469487547525966775197048264090, 0.0160525360588830157126949416124262, 0.1206005151863643737319975457467081, \
   0.0160525360588830157126949416124262, 0.1206005151863643737319975457467081, 0.8633469487547525966775197048264090, \
   0.0160525360588830157126949416124262, 0.8633469487547525966775197048264090, 0.1206005151863643737319975457467081, \
   0.0026971477967097875517998861738533, 0.0561949381877454995359855161041196, 0.9411079140155447220195128466002643, \
   0.0026971477967097875517998861738533, 0.9411079140155447220195128466002643, 0.0561949381877454995359855161041196, \
   0.0561949381877454995359855161041196, 0.0026971477967097875517998861738533, 0.9411079140155447220195128466002643, \
   0.0561949381877454995359855161041196, 0.9411079140155447220195128466002643, 0.0026971477967097875517998861738533, \
   0.9411079140155447220195128466002643, 0.0026971477967097875517998861738533, 0.0561949381877454995359855161041196, \
   0.9411079140155447220195128466002643, 0.0561949381877454995359855161041196, 0.0026971477967097875517998861738533, \
   0.0030156332779423624702863637736527, 0.2086750067484213488899769117779215, 0.7883093599736362699914593576977495, \
   0.0030156332779423624702863637736527, 0.7883093599736362699914593576977495, 0.2086750067484213488899769117779215, \
   0.2086750067484213488899769117779215, 0.0030156332779423624702863637736527, 0.7883093599736362699914593576977495, \
   0.2086750067484213488899769117779215, 0.7883093599736362699914593576977495, 0.0030156332779423624702863637736527, \
   0.7883093599736362699914593576977495, 0.0030156332779423624702863637736527, 0.2086750067484213488899769117779215, \
   0.7883093599736362699914593576977495, 0.2086750067484213488899769117779215, 0.0030156332779423624702863637736527, \
   0.0299053757884570198255502759820956, 0.7211512409120340860724240883428138, 0.2489433832995089357353890591184609, \
   0.0299053757884570198255502759820956, 0.2489433832995089357353890591184609, 0.7211512409120340860724240883428138, \
   0.7211512409120340860724240883428138, 0.0299053757884570198255502759820956, 0.2489433832995089357353890591184609, \
   0.7211512409120340860724240883428138, 0.2489433832995089357353890591184609, 0.0299053757884570198255502759820956, \
   0.2489433832995089357353890591184609, 0.0299053757884570198255502759820956, 0.7211512409120340860724240883428138, \
   0.2489433832995089357353890591184609, 0.7211512409120340860724240883428138, 0.0299053757884570198255502759820956, \
   0.0067566542224609888248054723192126, 0.6400554419405418693500564586429391, 0.3531879038369971635091815187479369, \
   0.0067566542224609888248054723192126, 0.3531879038369971635091815187479369, 0.6400554419405418693500564586429391, \
   0.6400554419405418693500564586429391, 0.0067566542224609888248054723192126, 0.3531879038369971635091815187479369, \
   0.6400554419405418693500564586429391, 0.3531879038369971635091815187479369, 0.0067566542224609888248054723192126, \
   0.3531879038369971635091815187479369, 0.0067566542224609888248054723192126, 0.6400554419405418693500564586429391, \
   0.3531879038369971635091815187479369, 0.6400554419405418693500564586429391, 0.0067566542224609888248054723192126}
#define SIQK_QUADRATURE_TRISYM_ORDER20_WEIGHT \
  {0.0125376079944966561247055025773989,0.0274718698764242139076507953632245,0.0274718698764242139076507953632245, \
   0.0274718698764242139076507953632245,0.0097652722770514236577676925321612,0.0097652722770514236577676925321612, \
   0.0097652722770514236577676925321612,0.0013984195353918234608348036829284,0.0013984195353918234608348036829284, \
   0.0013984195353918234608348036829284,0.0092921026251851831373462786700657,0.0092921026251851831373462786700657, \
   0.0092921026251851831373462786700657,0.0165778760323669269172164320025331,0.0165778760323669269172164320025331, \
   0.0165778760323669269172164320025331,0.0206677623486650786921448030852844,0.0206677623486650786921448030852844, \
   0.0206677623486650786921448030852844,0.0206677623486650786921448030852844,0.0206677623486650786921448030852844, \
   0.0206677623486650786921448030852844,0.0208222355211545064046507746979842,0.0208222355211545064046507746979842, \
   0.0208222355211545064046507746979842,0.0208222355211545064046507746979842,0.0208222355211545064046507746979842, \
   0.0208222355211545064046507746979842,0.0095686384198490608693488113090098,0.0095686384198490608693488113090098, \
   0.0095686384198490608693488113090098,0.0095686384198490608693488113090098,0.0095686384198490608693488113090098, \
   0.0095686384198490608693488113090098,0.0244527709689724634389840218773315,0.0244527709689724634389840218773315, \
   0.0244527709689724634389840218773315,0.0244527709689724634389840218773315,0.0244527709689724634389840218773315, \
   0.0244527709689724634389840218773315,0.0031557306306305341579709899946238,0.0031557306306305341579709899946238, \
   0.0031557306306305341579709899946238,0.0031557306306305341579709899946238,0.0031557306306305341579709899946238, \
   0.0031557306306305341579709899946238,0.0121367963653212975611017654387069,0.0121367963653212975611017654387069, \
   0.0121367963653212975611017654387069,0.0121367963653212975611017654387069,0.0121367963653212975611017654387069, \
   0.0121367963653212975611017654387069,0.0149664801438864486504698447788542,0.0149664801438864486504698447788542, \
   0.0149664801438864486504698447788542,0.0149664801438864486504698447788542,0.0149664801438864486504698447788542, \
   0.0149664801438864486504698447788542,0.0063275933217777392825187376956819,0.0063275933217777392825187376956819, \
   0.0063275933217777392825187376956819,0.0063275933217777392825187376956819,0.0063275933217777392825187376956819, \
   0.0063275933217777392825187376956819,0.0013425603120636958685146788994302,0.0013425603120636958685146788994302, \
   0.0013425603120636958685146788994302,0.0013425603120636958685146788994302,0.0013425603120636958685146788994302, \
   0.0013425603120636958685146788994302,0.0027760769163475539772489852907711,0.0027760769163475539772489852907711, \
   0.0027760769163475539772489852907711,0.0027760769163475539772489852907711,0.0027760769163475539772489852907711, \
   0.0027760769163475539772489852907711,0.0107398444741849414391099415411190,0.0107398444741849414391099415411190, \
   0.0107398444741849414391099415411190,0.0107398444741849414391099415411190,0.0107398444741849414391099415411190, \
   0.0107398444741849414391099415411190,0.0053678057381874528034004789844857,0.0053678057381874528034004789844857, \
   0.0053678057381874528034004789844857,0.0053678057381874528034004789844857,0.0053678057381874528034004789844857, \
   0.0053678057381874528034004789844857}

const Real TriangleQuadrature::trisym_order1_coord_  [] = SIQK_QUADRATURE_TRISYM_ORDER1_COORD;
const Real TriangleQuadrature::trisym_order1_weight_ [] = SIQK_QUADRATURE_TRISYM_ORDER1_WEIGHT;
const Real TriangleQuadrature::trisym_order2_coord_  [] = SIQK_QUADRATURE_TRISYM_ORDER2_COORD;
const Real TriangleQuadrature::trisym_order2_weight_ [] = SIQK_QUADRATURE_TRISYM_ORDER2_WEIGHT;
const Real TriangleQuadrature::trisym_order4_coord_  [] = SIQK_QUADRATURE_TRISYM_ORDER4_COORD;
const Real TriangleQuadrature::trisym_order4_weight_ [] = SIQK_QUADRATURE_TRISYM_ORDER4_WEIGHT;
const Real TriangleQuadrature::tritay_order6_coord_  [] = SIQK_QUADRATURE_TRITAY_ORDER6_COORD;
const Real TriangleQuadrature::tritay_order6_weight_ [] = SIQK_QUADRATURE_TRITAY_ORDER6_WEIGHT;
const Real TriangleQuadrature::trisym_order8_coord_  [] = SIQK_QUADRATURE_TRISYM_ORDER8_COORD;
const Real TriangleQuadrature::trisym_order8_weight_ [] = SIQK_QUADRATURE_TRISYM_ORDER8_WEIGHT;
const Real TriangleQuadrature::tritay_order12_coord_ [] = SIQK_QUADRATURE_TRITAY_ORDER12_COORD;
const Real TriangleQuadrature::tritay_order12_weight_[] = SIQK_QUADRATURE_TRITAY_ORDER12_WEIGHT;
const Real TriangleQuadrature::trisym_order20_coord_ [] = SIQK_QUADRATURE_TRISYM_ORDER20_COORD;
const Real TriangleQuadrature::trisym_order20_weight_[] = SIQK_QUADRATURE_TRISYM_ORDER20_WEIGHT;

void TriangleQuadrature
::get_coef (const int order, const Real*& coord, const Real*& weight, int& n) {
  switch (order) {
  case 1:
    coord = trisym_order1_coord_;
    weight = trisym_order1_weight_;
    n = 1;
    break;
  case 2:
    coord = trisym_order2_coord_;
    weight = trisym_order2_weight_;
    n = 3;
    break;
  case 4:
    coord = trisym_order4_coord_;
    weight = trisym_order4_weight_;
    n = 6;
    break;
  case 6:
    coord = tritay_order6_coord_;
    weight = tritay_order6_weight_;
    n = 11;
    break;
  case 8:
    coord = trisym_order8_coord_;
    weight = trisym_order8_weight_;
    n = 16;
    break;
  case 12:
    coord = tritay_order12_coord_;
    weight = tritay_order12_weight_;
    n = 32;
    break;
  case 20:
    coord = trisym_order20_coord_;
    weight = trisym_order20_weight_;
    n = 88;
    break;
  default:
    printf("TriangleQuadrature order %d not supported\n", order);
    assert(0);
  }  
}

bool TriangleQuadrature::is_order_supported (const int order) {
  for (const int orders : {1,2,4,6,8,12,20})
    if (order == orders) return true;
  return false;
}
} // namespace acorn
} // namespace woodland

#include "woodland/acorn/compose_quadrature.hpp"
#include "woodland/acorn/compose_lagrange_polynomial.hpp"
#include "woodland/acorn/triangle.hpp"
#include "woodland/acorn/util.hpp"

namespace woodland {
namespace acorn {

int TriangleQuadrature::unittest () {
  int ne = 0;

  static const Real coords[4][2] = {{-1, -1}, {1, -1}, {1, 1}, {-1, 1}};
  static const int tris[2][3] = {{0, 1, 2}, {0, 2, 3}};
  static const int tq_orders[] = {1, 2, 4, 6, 8, 12, 20};
  static const int np_max = 11;
  
  for (int np = 2; np <= np_max; ++np) {
    const auto* gll_x = get_x_gll(np);
    const auto* gll_w = get_w_gll(np);

    for (const int tq_order : tq_orders) {
      if (tq_order < 2*np - 3 || tq_order == 1) continue;
        
      TriangleQuadrature tq;
      const Real* tq_bary, * tq_w;
      int tq_n;
      assert(tq.is_order_supported(tq_order));
      tq.get_coef(tq_order, tq_bary, tq_w, tq_n);

      Real numerical[np_max*np_max] = {0};
      for (int trii = 0; trii < 2; ++trii) {
        const auto tri = tris[trii];
        Real t[6];
        for (int i = 0; i < 3; ++i)
          for (int d = 0; d < 2; ++d)
            t[2*i+d] = coords[tri[i]][d];
        for (int q = 0; q < tq_n; ++q) {
          Real p[2];
          acorn::Triangle2D::barycentric_to_xy(t, &tq_bary[3*q], p);
          Real gi[np_max], gj[np_max];
          eval_lagrange_poly_basis(np, gll_x, p[0], gi);
          eval_lagrange_poly_basis(np, gll_x, p[1], gj);
          for (int i = 0; i < np; ++i)
            for (int j = 0; j < np; ++j) {
              // Each triangle's area is 2, and tq_w applies to a unit-area
              // triangle.
              numerical[i*np + j] += 2 * tq_w[q] * gi[i] * gj[j];
            }
        }
      }

      Real tol = 1e2*std::numeric_limits<Real>::epsilon();
      for (int i = 0; i < np; ++i)
        for (int j = 0; j < np; ++j) {
          // gll_w is the integral over [-1,1], so no modification is needed for
          // this domain.
          const Real analytical = gll_w[i] * gll_w[j];
          const Real rd = reldif(analytical, numerical[np*i + j]);
          if (rd > tol) {
            printf("%d %d %d %d %1.3e %1.3e %1.1e\n",
                   tq_order, np, i, j,
                   analytical, numerical[np*i + j], rd);
            ++ne;
          }
        }
    }
  }
  
  return ne;
}

} // namespace acorn
} // namespace woodland
